<div class="reports">
  <header>
    <h2>Reportes</h2>
    <p>Visualiza la salud del inventario con métricas clave.</p>
  </header>

  <ng-container *ngIf="vm$ | async as vm">
    <section class="metrics">
      <article class="metric-card primary">
        <span class="material-symbols-outlined">inventory_2</span>
        <div>
          <h3>Stock total</h3>
          <p>{{ vm.totalStock | quantityFormat }} unidades</p>
          <small>Inventario + cosechas disponibles</small>
        </div>
      </article>
      <article class="metric-card info">
        <span class="material-symbols-outlined">warehouse</span>
        <div>
          <h3>Inventario disponible</h3>
          <p>{{ vm.inventoryStock | quantityFormat }} unidades</p>
          <small>Sumatoria de todos los ítems registrados</small>
        </div>
      </article>
      <article class="metric-card success">
        <span class="material-symbols-outlined">local_florist</span>
        <div>
          <h3>Cosecha acumulada</h3>
          <p>{{ vm.harvestSummary.totalQuantity | quantityFormat }} unidades</p>
          <small>{{ vm.harvestSummary.totalHarvests }} registros de cosecha activos</small>
        </div>
      </article>
      <article class="metric-card success">
        <span class="material-symbols-outlined">health_and_safety</span>
        <div>
          <h3>Stock saludable</h3>
          <p>{{ vm.healthyCount }}</p>
          <small>Inventario por encima de 10 unidades</small>
        </div>
      </article>
      <article class="metric-card warning">
        <span class="material-symbols-outlined">warning</span>
        <div>
          <h3>Alertas críticas</h3>
          <p>{{ vm.criticalItems.length }}</p>
          <small>Productos que requieren reposición</small>
        </div>
      </article>
    </section>

    <section class="harvest-insights">
      <div class="harvest-insights__header">
        <h3>Indicadores de cosecha</h3>
        <p>Seguimiento de unidades cosechadas y su distribución.</p>
      </div>
      <div class="harvest-insights__cards">
        <article>
          <span class="label">Promedio por registro</span>
          <strong>{{ vm.harvestSummary.averageQuantity | quantityFormat }} unidades</strong>
        </article>
        <article>
          <span class="label">Categorías activas</span>
          <strong>{{ (vm.harvestSummary.byCategory | keyvalue).length }}</strong>
        </article>
        <article>
          <span class="label">Últimas cosechas</span>
          <strong>{{ vm.harvestSummary.recentHarvests.length }}</strong>
        </article>
      </div>

      <div class="harvest-insights__body" *ngIf="vm.harvestSummary.totalHarvests; else emptyHarvest">
        <div class="harvest-insights__categories" *ngIf="vm.harvestSummary.byCategory | keyvalue as harvestCategories">
          <h4>Por categoría</h4>
          <div class="chips">
            <div class="chip" *ngFor="let entry of harvestCategories">
              <span class="chip__label">{{ entry.key }}</span>
              <span class="chip__value">{{ entry.value | quantityFormat }} unidades</span>
            </div>
          </div>
        </div>
        <div class="harvest-insights__recent" *ngIf="vm.harvestSummary.recentHarvests.length">
          <h4>Cosechas recientes</h4>
          <ul>
            <li *ngFor="let harvest of vm.harvestSummary.recentHarvests">
              <div>
                <strong>{{ harvest.crop }}</strong>
                <small>{{ harvest.date | date:'mediumDate' }}</small>
              </div>
              <span>{{ harvest.quantity | quantityFormat }} unidades</span>
            </li>
          </ul>
        </div>
      </div>
      <ng-template #emptyHarvest>
        <article class="empty">
          <span class="material-symbols-outlined">grass</span>
          <p>Todavía no hay información de cosechas para graficar.</p>
        </article>
      </ng-template>
    </section>

    <section class="profit" *ngIf="vm.harvestProfit.entries.length">
      <div class="profit__header">
        <h3>Gráfico de % de ganancias</h3>
        <p>Margen promedio {{ vm.harvestProfit.averageMargin | number:'1.0-1' }}% sobre los precios registrados (CLP).</p>
      </div>
      <ul class="profit-chart">
        <li *ngFor="let entry of vm.harvestProfit.entries">
          <div class="profit-chart__info">
            <strong>{{ entry.crop }}</strong>
            <small>Compra {{ entry.purchasePriceClp | currency:'CLP':'symbol-narrow':'1.0-0' }} · Venta {{ entry.salePriceClp | currency:'CLP':'symbol-narrow':'1.0-0' }}</small>
          </div>
          <div class="profit-chart__bar">
            <div class="profit-chart__fill" [style.width.%]="entry.margin > 100 ? 100 : entry.margin < 0 ? 0 : entry.margin"></div>
            <span class="profit-chart__value">{{ entry.margin | number:'1.0-1' }}%</span>
          </div>
        </li>
      </ul>
    </section>

    <section class="categories">
      <h3>Distribución por categoría</h3>
      <article class="empty" *ngIf="(vm.items.length === 0)">
        <span class="material-symbols-outlined">workspaces</span>
        <p>Aún no hay categorías registradas. Agrega productos al inventario.</p>
      </article>
      <div class="chips" *ngIf="vm.items.length">
        <div class="chip" *ngFor="let entry of vm.categoryTotals | keyvalue">
          <span class="chip__label">{{ entry.key }}</span>
          <span class="chip__value">{{ entry.value | quantityFormat }} unidades</span>
        </div>
      </div>
    </section>

    <section class="critical">
      <h3>Detalle de stock crítico</h3>
      <article class="empty" *ngIf="!vm.criticalItems.length">
        <span class="material-symbols-outlined">verified</span>
        <p>Todo el inventario se encuentra en niveles seguros.</p>
      </article>
      <ul *ngIf="vm.criticalItems.length">
        <li *ngFor="let item of vm.criticalItems">
          <div class="item__icon">
            <span class="material-symbols-outlined">inventory</span>
          </div>
          <div>
            <strong>{{ item.name }}</strong>
            <span>Quedan {{ item.quantity | quantityFormat }} unidades</span>
            <small>Categoría: {{ item.category }}</small>
          </div>
          <span class="badge">Reposición</span>
        </li>
      </ul>
    </section>

    <section class="summary">
      <h3>Resumen de existencias</h3>
      <article class="summary-card">
        <div class="summary-row">
          <span class="material-symbols-outlined">trending_up</span>
          <div>
            <strong>Mayor stock</strong>
            <span>{{ vm.highestStock ? vm.highestStock.name + ' (' + (vm.highestStock.quantity | quantityFormat) + ' unidades)' : 'Sin datos' }}</span>
          </div>
        </div>
        <div class="summary-row">
          <span class="material-symbols-outlined">trending_down</span>
          <div>
            <strong>Menor stock</strong>
            <span>{{ vm.lowestStock ? vm.lowestStock.name + ' (' + (vm.lowestStock.quantity | quantityFormat) + ' unidades)' : 'Sin datos' }}</span>
          </div>
        </div>
        <div class="summary-row">
          <span class="material-symbols-outlined">scale</span>
          <div>
            <strong>Stock promedio</strong>
            <span>{{ vm.averageStock | quantityFormat }} unidades por producto</span>
          </div>
        </div>
      </article>
    </section>
  </ng-container>
</div>
