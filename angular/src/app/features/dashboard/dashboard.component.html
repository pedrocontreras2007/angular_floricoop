<div class="dashboard">
  <header class="dashboard__header">
    <div>
      <h2>Panel de control</h2>
      <p>Administra la cooperativa desde este panel centralizado.</p>
    </div>
  <a [routerLink]="'/cosechas'" class="header__action">
      <span class="material-symbols-outlined">add_circle</span>
      <span>Registrar cosecha</span>
    </a>
  </header>

  <ng-container *ngIf="summary$ | async as vm">
    <section class="summary-grid">
      <article class="summary-card primary">
        <span class="material-symbols-outlined">spa</span>
        <div>
          <h3>Cosechas registradas</h3>
          <p class="value">{{ vm.totalHarvests }}</p>
          <p class="helper">{{ vm.totalHarvestQuantity | quantityFormat }} unidades acumuladas</p>
        </div>
      </article>
      <article class="summary-card info">
        <span class="material-symbols-outlined">inventory_2</span>
        <div>
          <h3>Productos inventariados</h3>
          <p class="value">{{ vm.inventoryCount }}</p>
          <p class="helper">Stock en seguimiento activo</p>
        </div>
      </article>
      <article class="summary-card success">
        <span class="material-symbols-outlined">event_available</span>
        <div>
          <h3>Stock saludable</h3>
          <p class="value">{{ vm.healthyInventory }}</p>
          <p class="helper">Con existencias superiores a 10 unidades</p>
        </div>
      </article>
      <article class="summary-card warning">
        <span class="material-symbols-outlined">warning</span>
        <div>
          <h3>Alertas de reposición</h3>
          <p class="value">{{ vm.criticalItems.length }}</p>
          <p class="helper">Productos con niveles críticos</p>
        </div>
      </article>
    </section>

    <section class="dashboard__analytics" *ngIf="vm.stockByCategory.length || vm.topInventoryItems.length || vm.economicStats.entries.length">
      <article class="analytics-card" *ngIf="vm.stockByCategory.length">
        <div class="analytics-card__header">
          <span class="material-symbols-outlined">stacked_bar_chart</span>
          <div>
            <h3>Stock por categoría</h3>
            <p>Distribución total de unidades disponibles</p>
          </div>
        </div>
        <div class="bars">
          <div class="bar" *ngFor="let stat of vm.stockByCategory; trackBy: trackCategory">
            <div class="bar__label">
              <span>{{ stat.category | titlecase }}</span>
              <span>{{ stat.total | quantityFormat }} unidades</span>
            </div>
            <div class="bar__track">
              <div class="bar__fill" [style.width.%]="vm.maxCategoryTotal ? (stat.total / vm.maxCategoryTotal) * 100 : 0"></div>
            </div>
          </div>
        </div>
      </article>

      <article class="analytics-card" *ngIf="vm.topInventoryItems.length">
        <div class="analytics-card__header">
          <span class="material-symbols-outlined">trending_up</span>
          <div>
            <h3>Top inventario disponible</h3>
            <p>Productos con mayor stock actual</p>
          </div>
        </div>
        <ul class="top-stock">
          <li *ngFor="let item of vm.topInventoryItems; trackBy: trackInventory">
            <div>
              <strong>{{ item.name }}</strong>
              <small>{{ item.category | titlecase }}</small>
            </div>
            <span>{{ item.quantity | quantityFormat }} unidades</span>
          </li>
        </ul>
      </article>

      <article class="analytics-card" *ngIf="vm.economicStats.entries.length">
        <div class="analytics-card__header">
          <span class="material-symbols-outlined">attach_money</span>
          <div>
            <h3>Rentabilidad de cosechas</h3>
            <p>Margen promedio {{ vm.economicStats.averageMargin | number:'1.0-1' }}% sobre precios en CLP</p>
          </div>
        </div>
        <ul class="profit-chart">
          <li *ngFor="let entry of vm.economicStats.entries">
            <div class="profit-chart__info">
              <strong>{{ entry.crop }}</strong>
              <small>Compra {{ entry.purchasePriceClp | currency:'CLP':'symbol-narrow':'1.0-0' }} · Venta {{ entry.salePriceClp | currency:'CLP':'symbol-narrow':'1.0-0' }}</small>
            </div>
            <div class="profit-chart__bar">
              <div class="profit-chart__fill" [style.width.%]="Math.min(100, Math.max(0, entry.margin))"></div>
              <span class="profit-chart__value">{{ entry.margin | number:'1.0-1' }}%</span>
            </div>
          </li>
        </ul>
      </article>
    </section>

    <section class="dashboard__schedule" *ngIf="calendarVm$ | async as calendar">
      <article class="schedule-card schedule-card--calendar">
        <div class="calendar__header">
          <div>
            <p class="calendar__today">{{ calendar.todayLabel }}</p>
            <h3>{{ calendar.monthLabel }}</h3>
          </div>
          <div class="calendar__controls">
            <button type="button" class="calendar__control" (click)="goToPreviousMonth()" aria-label="Mes anterior">
              <span class="material-symbols-outlined">chevron_left</span>
            </button>
            <button type="button" class="calendar__control" (click)="goToNextMonth()" aria-label="Mes siguiente">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
        </div>

        <div class="calendar__weekdays">
          <span *ngFor="let day of weekDayLabels">{{ day }}</span>
        </div>

        <div class="calendar__weeks">
          <div class="calendar__week" *ngFor="let week of calendar.weeks">
            <button
              type="button"
              class="calendar__day"
              *ngFor="let day of week; trackBy: trackCalendarDay"
              [class.calendar__day--muted]="!day.inCurrentMonth"
              [class.calendar__day--today]="day.isToday"
              [class.calendar__day--selected]="day.isoDate === reminderForm.controls.date.value"
              (click)="selectDate(day)"
              [attr.aria-label]="day.date | date:'fullDate'"
            >
              <span class="calendar__day-number">{{ day.label }}</span>
              <div class="calendar__events" *ngIf="day.reminders.length">
                <span
                  class="calendar__event"
                  *ngFor="let reminder of day.reminders | slice:0:2"
                  [title]="reminder.title"
                >
                  {{ reminder.title }}
                </span>
                <span *ngIf="day.reminders.length > 2" class="calendar__event calendar__event--more">
                  +{{ day.reminders.length - 2 }}
                </span>
              </div>
            </button>
          </div>
        </div>
      </article>

      <div class="schedule__side">
        <article class="schedule-card">
          <h3>Agregar recordatorio</h3>
          <p class="schedule__helper">Selecciona una fecha del calendario o utiliza el selector para programar recordatorios.</p>
          <div class="schedule__edit-banner" *ngIf="editingReminderId">
            <div class="schedule__edit-info">
              <span class="material-symbols-outlined">edit_note</span>
              <span>Estás editando un recordatorio existente.</span>
            </div>
            <button type="button" class="schedule__edit-cancel" (click)="cancelReminderEdit()">
              Cancelar edición
            </button>
          </div>
          <form [formGroup]="reminderForm" (ngSubmit)="submitReminder()" novalidate class="schedule__form">
            <div class="schedule__field">
              <label for="reminder-title">Título</label>
              <input id="reminder-title" type="text" formControlName="title" placeholder="Ej. Reunión con proveedores">
              <small *ngIf="reminderForm.controls.title.invalid && (reminderForm.controls.title.dirty || reminderForm.controls.title.touched)">
                Ingresa un título (máx. 100 caracteres).
              </small>
            </div>
            <div class="schedule__field-row">
              <div class="schedule__field">
                <label for="reminder-date">Fecha</label>
                <input id="reminder-date" type="date" formControlName="date">
                <small *ngIf="reminderForm.controls.date.invalid && (reminderForm.controls.date.dirty || reminderForm.controls.date.touched)">
                  Selecciona una fecha válida.
                </small>
              </div>
              <div class="schedule__field">
                <label for="reminder-time">Hora (opcional)</label>
                <input id="reminder-time" type="time" formControlName="time">
              </div>
            </div>
            <div class="schedule__field">
              <label for="reminder-note">Nota</label>
              <textarea id="reminder-note" rows="3" formControlName="note" placeholder="Detalles adicionales para el equipo"></textarea>
              <small *ngIf="reminderForm.controls.note.invalid && (reminderForm.controls.note.dirty || reminderForm.controls.note.touched)">
                La nota supera el máximo permitido (250 caracteres).
              </small>
            </div>
            <div class="schedule__actions-row">
              <button type="submit" class="schedule__cta">
              <span class="material-symbols-outlined">add_task</span>
                <span>{{ editingReminderId ? 'Actualizar recordatorio' : 'Guardar recordatorio' }}</span>
              </button>
              <button type="button" class="schedule__cta schedule__cta--ghost" *ngIf="editingReminderId" (click)="cancelReminderEdit()">
                <span class="material-symbols-outlined">close</span>
                <span>Cancelar</span>
              </button>
            </div>
          </form>
        </article>

        <article class="schedule-card">
          <div class="schedule__table-header">
            <h3>Próximos recordatorios</h3>
            <p *ngIf="calendar.upcomingReminders.length">
              {{ calendar.upcomingReminders.length === 1
                ? '1 evento programado en agenda.'
                : calendar.upcomingReminders.length + ' eventos programados en agenda.' }}
            </p>
          </div>
          <ng-container *ngIf="calendar.upcomingReminders.length; else noUpcoming">
            <div class="schedule__table-wrapper">
              <table class="schedule__table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Recordatorio</th>
                    <th>Nota</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let reminder of calendar.upcomingReminders; trackBy: trackReminder">
                    <td>{{ reminder.scheduledAt | date:'EEEE d MMM' }}</td>
                    <td>{{ reminder.scheduledAt | date:'HH:mm' }}</td>
                    <td>{{ reminder.title }}</td>
                    <td>{{ reminder.note || 'Sin nota' }}</td>
                    <td>
                      <div class="schedule__actions">
                        <button type="button" class="schedule__action-btn" (click)="startReminderEdit(reminder)">
                          <span class="material-symbols-outlined">edit</span>
                          <span>Editar</span>
                        </button>
                        <button type="button" class="schedule__action-btn schedule__action-btn--danger" (click)="deleteReminder(reminder)">
                          <span class="material-symbols-outlined">delete</span>
                          <span>Eliminar</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-container>
          <ng-template #noUpcoming>
            <p class="schedule__empty">No hay recordatorios próximos. Agrega uno para organizar las tareas de la cooperativa.</p>
          </ng-template>
        </article>
      </div>
    </section>

    <section class="dashboard__alerts">
      <h3>Alertas prioritarias</h3>
      <ng-container *ngIf="vm.criticalItems.length; else allGood">
        <article class="alerts__card">
          <div class="alerts__header">
            <span class="material-symbols-outlined">priority_high</span>
            <div>
              <h4>Productos por reponer</h4>
              <p>{{ vm.criticalItems.length }} ítems requieren seguimiento inmediato</p>
            </div>
          </div>
          <ul>
            <li *ngFor="let item of vm.criticalItems; trackBy: trackInventory">
              <div>
                <strong>{{ item.name }}</strong>
                <span>Quedan {{ item.quantity | quantityFormat }} unidades</span>
                <small>Categoría: {{ item.category }}</small>
              </div>
              <span class="badge">Crítico</span>
            </li>
          </ul>
          <a routerLink="/alertas" class="alerts__cta">
            <span>Ver detalle de alertas</span>
            <span class="material-symbols-outlined">chevron_right</span>
          </a>
        </article>
      </ng-container>
      <ng-template #allGood>
        <article class="alerts__empty">
          <span class="material-symbols-outlined">verified</span>
          <h4>Todo el inventario está en niveles seguros</h4>
          <p>Recuerda actualizar las existencias cuando recibas nuevos insumos.</p>
        </article>
      </ng-template>
    </section>

    <section class="dashboard__actions">
      <h3>Secciones clave</h3>
      <div class="actions__grid">
  <a *ngFor="let action of actions" [routerLink]="action.path" class="action-card" [ngClass]="action.accent">
          <div class="action-card__icon">
            <span class="material-symbols-outlined">{{ action.icon }}</span>
          </div>
          <div>
            <h4>{{ action.title }}</h4>
            <p>{{ action.subtitle }}</p>
          </div>
          <span class="material-symbols-outlined action-card__chevron">chevron_right</span>
        </a>
      </div>
    </section>

    <section class="dashboard__recent" *ngIf="vm.recentHarvests.length">
      <h3>Últimas cosechas registradas</h3>
      <ul>
        <li *ngFor="let harvest of vm.recentHarvests">
          <div>
            <strong>{{ harvest.crop }}</strong>
            <span>{{ harvest.quantity | quantityFormat }} unidades · {{ harvest.category }} categoría</span>
            <small *ngIf="harvest.purchasePriceClp">Compra: {{ harvest.purchasePriceClp | currency:'CLP':'symbol-narrow':'1.0-0' }}</small>
            <small *ngIf="harvest.salePriceClp">Venta: {{ harvest.salePriceClp | currency:'CLP':'symbol-narrow':'1.0-0' }}</small>
          </div>
          <time [attr.datetime]="harvest.date.toISOString()">{{ harvest.date | date:'mediumDate' }} · {{ harvest.date | date:'shortTime' }}</time>
        </li>
      </ul>
    </section>
  </ng-container>
</div>
